<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Peluquer√≠a ‚Äî Turnos</title>
  <style>
    :root{
      --bg:#ffffff;
      --rojo:#d62828;
      --celeste:#08a0d1;
      --gris:#f5f5f5;
      --texto:#1d1d1d;
      --radius:16px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--texto);}
    header{
      background:linear-gradient(120deg, var(--rojo), var(--celeste));
      color:#fff;
      padding:1rem 1.3rem 1.1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }
    header h1{margin:0;font-size:1.3rem;font-weight:700;}
    header small{display:block;font-size:.75rem;opacity:.85;}
    .admin-badge{
      background:rgba(255,255,255,.15);
      padding:.25rem .6rem;
      border-radius:999px;
      font-size:.7rem;
      display:flex;
      align-items:center;
      gap:.25rem;
    }
    .container{max-width:1080px;margin:1.2rem auto;padding:0 1rem 1.8rem;}
    .panel{
      background:#fff;
      border:1px solid #e5e5e5;
      border-radius:var(--radius);
      padding:1rem;
      box-shadow:0 14px 40px rgba(0,0,0,.03);
    }
    .tabs{
      display:flex;
      gap:.5rem;
      margin-bottom:1rem;
      border-bottom:1px solid #eee;
    }
    .tab-btn{
      border:none;
      background:transparent;
      padding:.6rem 1rem .85rem;
      font-weight:600;
      color:#777;
      cursor:pointer;
      border-bottom:3px solid transparent;
      transition:.2s;
    }
    .tab-btn.active{
      color:var(--rojo);
      border-color:var(--rojo);
      background:rgba(214,40,40,.04);
      border-top-left-radius:8px;
      border-top-right-radius:8px;
    }
    .hidden{display:none;}
    label{display:block;font-size:.78rem;margin-bottom:.35rem;}
    input,select,textarea{
      width:100%;
      padding:.55rem .55rem;
      border:1px solid #dcdcdc;
      border-radius:10px;
      font-size:.85rem;
      background:#fff;
    }
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(8,160,209,.18);border-color:rgba(8,160,209,.6);}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;}
    .col-6{flex:1 1 200px;}
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.3rem;
      border:none;
      border-radius:999px;
      padding:.5rem 1.1rem;
      font-weight:600;
      cursor:pointer;
      transition:.15s;
    }
    .btn-primary{background:var(--rojo);color:#fff;}
    .btn-primary:hover{filter:brightness(.93);}
    .btn-soft{background:rgba(8,160,209,.08);color:var(--celeste);}
    .btn-danger{background:rgba(214,40,40,.08);color:var(--rojo);}
    .section-title{
      font-weight:600;
      margin:.8rem 0 .4rem;
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    .pill{background:rgba(214,40,40,.12);color:var(--rojo);font-size:.65rem;padding:.12rem .4rem;border-radius:999px;}
    .turno-card{
      border:1px solid #eee;
      border-radius:12px;
      padding:.6rem .75rem .5rem;
      margin-bottom:.45rem;
      display:flex;
      justify-content:space-between;
      gap:.6rem;
      background:#fff;
      align-items:center;
    }
    .turno-info small{display:block;font-size:.7rem;color:#666;}
    .hora-badge{
      background:rgba(8,160,209,.12);
      color:var(--celeste);
      font-weight:600;
      padding:.2rem .6rem;
      border-radius:999px;
      font-size:.75rem;
      display:inline-flex;
      align-items:center;
      gap:.2rem;
    }
    .empty{
      padding:.8rem;
      background:rgba(0,0,0,.02);
      border:1px dashed #ddd;
      border-radius:12px;
      text-align:center;
      font-size:.78rem;
      color:#777;
    }
    .service-item{
      display:flex;
      gap:.4rem;
      margin-bottom:.4rem;
    }
    .service-item input{flex:1;}
    .day-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:.6rem;
      margin-top:.45rem;
    }
    .day-box{
      border:1px solid #eee;
      border-radius:10px;
      padding:.5rem .6rem .6rem;
      background:#fafafa;
    }
    .day-box h4{margin:0;font-size:.7rem;letter-spacing:.03em;text-transform:uppercase;color:#444;display:flex;justify-content:space-between;align-items:center;}
    .day-box small{font-size:.65rem;color:#777;}
    .switch{
      appearance:none;
      width:34px;
      height:18px;
      background:#ccc;
      border-radius:999px;
      position:relative;
      cursor:pointer;
      outline:none;
    }
    .switch:checked{background:var(--celeste);}
    .switch:before{
      content:"";
      width:14px;height:14px;
      background:#fff;
      border-radius:50%;
      position:absolute;
      top:2px;left:2px;
      transition:.15s;
    }
    .switch:checked:before{left:18px;}
    a.link-inline{color:var(--celeste);text-decoration:none;font-size:.78rem;}
    a.link-inline:hover{text-decoration:underline;}
    .small-input{width:100%;font-size:.7rem;padding:.4rem .5rem;border-radius:8px;border:1px solid #ddd;background:#fdfdfd;}
    .inline-copy{
      display:flex;
      gap:.4rem;
      align-items:center;
      max-width:340px;
    }
    .tag-disabled{
      background:rgba(214,40,40,.1);
      color:var(--rojo);
      padding:.25rem .55rem;
      border-radius:999px;
      font-size:.7rem;
      display:inline-flex;
      gap:.5rem;
      align-items:center;
      margin:.15rem .3rem .15rem 0;
    }
    .row-inline{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;}
    @media (max-width:720px){
      .tabs{flex-wrap:wrap;}
      header{flex-direction:column;align-items:flex-start;}
      .turno-card{flex-direction:column;align-items:flex-start;}
      .inline-copy{flex-direction:column;align-items:stretch;max-width:none;}
      .row-inline{flex-direction:column;align-items:flex-start;}
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>Peluquer√≠a ‚Äî Turnos</h1>
      <small id="adminPhoneLabel">Registr√° el n√∫mero para administrar</small>
    </div>
    <div id="adminBadge" class="admin-badge" style="display:none;">üëë Admin</div>
  </header>

  <div class="container">
    <!-- Registro admin -->
    <div id="registerPanel" class="panel">
      <h2 style="margin-top:0;font-size:1rem;">Registrar n√∫mero administrador</h2>
      <p style="font-size:.82rem;color:#555;margin-bottom:.7rem;">
        Este ser√° el n√∫mero donde recibir√°s las notificaciones. Solo se registra una vez.
      </p>
      <label for="adminPhone">N√∫mero (WhatsApp / Tel√©fono)</label>
      <input type="tel" id="adminPhone" placeholder="+54 264 ...">
      <button class="btn btn-primary" style="margin-top:.6rem;" id="saveAdmin">Guardar como admin</button>
    </div>

    <!-- App -->
    <div id="appPanel" class="panel hidden">
      <div id="tabs" class="tabs">
        <button class="tab-btn active" data-tab="tomar">Tomar turno</button>
        <button class="tab-btn" data-tab="turnos" id="tabTurnos">Turnos</button>
        <button class="tab-btn" data-tab="ajustes" id="tabAjustes">Ajustes</button>
      </div>

      <!-- TOMAR -->
      <div id="tab-tomar">
        <div class="row">
          <div class="col-6">
            <label>Nombre del cliente</label>
            <input id="clienteNombre" type="text" placeholder="Ej: Ana P√©rez">
          </div>
          <div class="col-6">
            <label>Tel√©fono del cliente (opcional)</label>
            <input id="clienteTel" type="tel" placeholder="+54...">
          </div>
        </div>
        <div class="row" style="margin-top:.5rem;">
          <div class="col-6">
            <label>Fecha</label>
            <input id="fechaTurno" type="date">
          </div>
          <div class="col-6">
            <label>Servicio</label>
            <select id="servicioSelect"></select>
          </div>
        </div>
        <div class="section-title" style="margin-top:1rem;">Horarios disponibles <span class="pill">30 min</span></div>
        <div id="horariosContainer" class="row" style="gap:.4rem;"></div>
        <button id="confirmarTurno" class="btn btn-primary" style="margin-top:1rem;">Confirmar turno</button>
        <p id="msgTurno" style="margin-top:.7rem;font-size:.8rem;color:#333;"></p>
        <p id="linkWhats" style="font-size:.75rem;"></p>
      </div>

      <!-- TURNOS -->
      <div id="tab-turnos" class="hidden">
        <h3 style="margin-top:0;font-size:1rem;">Agenda del d√≠a</h3>
        <label>Eleg√≠ fecha</label>
        <input type="date" id="agendaFecha" style="max-width:200px;margin-bottom:.7rem;">
        <div id="listaTurnos"></div>
      </div>

      <!-- AJUSTES -->
      <div id="tab-ajustes" class="hidden">
        <h3 style="margin-top:0;font-size:1rem;">Ajustes</h3>
        <p style="font-size:.7rem;color:#555;">Solo visible para admin.</p>

        <!-- ‚úÖ Switch usar horarios por semana -->
        <div class="row-inline" style="margin-bottom:.6rem;">
          <label style="margin-bottom:0;font-weight:600;">Usar horarios por semana</label>
          <label style="display:flex;align-items:center;gap:.35rem;">
            <input type="checkbox" id="useWeekly" class="switch" checked>
            <span style="font-size:.72rem;color:#555;">Si lo desactiv√°s no se muestran horarios</span>
          </label>
        </div>

        <div class="section-title">Servicios</div>
        <!-- ‚úÖ fila de botones arriba -->
        <div class="row-inline" style="margin-bottom:.4rem;">
          <button id="agregarServicio" class="btn btn-soft" type="button">+ Agregar servicio</button>
          <button id="guardarServicios" class="btn btn-soft" type="button">üíæ Guardar precios</button>
          <small id="msgServicios" style="font-size:.68rem;color:green;"></small>
        </div>
        <div id="serviciosList"></div>

        <div class="section-title" style="margin-top:1rem;">Horarios por d√≠a</div>
        <p style="font-size:.7rem;color:#555;">Si un d√≠a est√° vac√≠o o deshabilitado, no se muestran turnos ese d√≠a.</p>
        <div id="horariosPorDia" class="day-grid"></div>

        <!-- ‚úÖ D√≠as deshabilitados -->
        <div class="section-title" style="margin-top:1rem;">D√≠as deshabilitados (calendario)</div>
        <div class="row-inline" style="margin-bottom:.4rem;">
          <input type="date" id="disabledDayPicker" style="max-width:200px;">
          <button id="addDisabledDay" class="btn btn-soft" type="button">‚ûñ Deshabilitar d√≠a</button>
        </div>
        <div id="disabledDaysList"></div>

        <div class="section-title" style="margin-top:1.1rem;">Link para clientes</div>
        <p style="font-size:.7rem;color:#555;margin-bottom:.3rem;">
          Compart√≠ este link: solo ver√°n la pantalla de ‚ÄúTomar turno‚Äù.
        </p>
        <div class="inline-copy">
          <input id="publicLink" class="small-input" readonly value=""/>
          <button id="copyLink" type="button" class="btn btn-soft">üìã Copiar</button>
        </div>

        <p style="margin-top:1rem;">
          <a href="#" id="irTomar" class="link-inline">‚û°Ô∏è Ir a la pesta√±a ‚ÄúTomar turno‚Äù</a>
        </p>

        <div class="section-title" style="margin-top:1.1rem;">Administrador</div>
        <p style="font-size:.7rem;color:#555;">Si quer√©s cambiar el n√∫mero de admin, cerr√° sesi√≥n y volv√© a entrar.</p>
        <button id="cerrarSesion" class="btn btn-danger" type="button">üîê Cerrar sesi√≥n de admin</button>

        <button id="guardarAjustes" class="btn btn-primary" style="margin-top:1rem;display:block;">Guardar ajustes</button>
        <p id="msgAjustes" style="font-size:.75rem;margin-top:.5rem;color:green;"></p>
      </div>
    </div>
  </div>

  <script>
    // ====================
    // Firebase
    // ====================
    const firebaseConfig = {
      apiKey: "AIzaSyAk5Pn5YJAFbgQtpwjhkZ0MIJ3JtnwLd0M",
      authDomain: "peluqueria-eb0cf.firebaseapp.com",
      projectId: "peluqueria-eb0cf",
      storageBucket: "peluqueria-eb0cf.firebasestorage.app",
      messagingSenderId: "749771581273",
      appId: "1:749771581273:web:a3cf588fa53d9b3aff4e48",
      measurementId: "G-JHSFYSB57V"
    };
    const appFB = firebase.initializeApp(firebaseConfig);
    const db = appFB.firestore();

    // ====================
    // STORAGE KEYS
    // ====================
    const STORAGE_ADMIN = "pelu_admin_phone";
    const STORAGE_ADMIN_CODE = "pelu_admin_code";
    const STORAGE_SERVICIOS = "pelu_servicios";
    const STORAGE_HORARIOS = "pelu_horarios";
    const STORAGE_TURNOS_BASE = "pelu_turnos";
    const STORAGE_DISABLED_DAYS = "pelu_disabled_days";
    const STORAGE_USE_WEEKLY = "pelu_use_weekly";

    const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];

    // ====================
    // URL PARAMS (formato nuevo chico + compatibilidad)
    // ====================
    const params = new URLSearchParams(location.search);
    const tokenParam = params.get("t"); // nuevo formato corto
    const isPublicLink = params.has("solo") || !!tokenParam;
    const oldPublicCode = params.get("code") || null;
    const oldPublicAdminParam = params.get("ap") || null;

    // vars del link p√∫blico
    let publicCode = null;
    let publicAdminPhone = null;

    // decodificar formato nuevo
    if(tokenParam){
      try{
        const decoded = JSON.parse(atob(tokenParam));
        publicCode = decoded.c || null;
        publicAdminPhone = decoded.p || null;
      }catch(e){
        publicCode = null;
        publicAdminPhone = null;
      }
    } else {
      // compatibilidad vieja
      publicCode = oldPublicCode;
      if(oldPublicAdminParam){
        try{ publicAdminPhone = atob(decodeURIComponent(oldPublicAdminParam)); }catch(e){ publicAdminPhone = null; }
      }
    }

    // ====================
    // ADMIN HELPERS
    // ====================
    function getAdminPhone(){ return localStorage.getItem(STORAGE_ADMIN); }
    function setAdminPhone(p){ localStorage.setItem(STORAGE_ADMIN, p); }
    function getAdminCode(){ return localStorage.getItem(STORAGE_ADMIN_CODE); }
    function setAdminCode(c){ localStorage.setItem(STORAGE_ADMIN_CODE, c); }
    function generateAdminCode(){
      return "ADM-" + Math.random().toString(36).substring(2,8).toUpperCase();
    }

    // disabled days
    function getDisabledDays(){
      const d = localStorage.getItem(STORAGE_DISABLED_DAYS);
      if(d){ return JSON.parse(d); }
      return [];
    }
    function saveDisabledDays(d){
      localStorage.setItem(STORAGE_DISABLED_DAYS, JSON.stringify(d));
    }

    // usar semanal
    function getUseWeekly(){
      const v = localStorage.getItem(STORAGE_USE_WEEKLY);
      if(v===null) return true;
      return v==="1";
    }
    function setUseWeekly(val){
      localStorage.setItem(STORAGE_USE_WEEKLY, val ? "1" : "0");
    }

    // ====================
    // TURNOS POR ADMIN (local)
    // ====================
    function getTurnosStorageKey(){
      if(isPublicLink && publicCode){
        return `${STORAGE_TURNOS_BASE}_${publicCode}`;
      }
      const myCode = getAdminCode();
      if(myCode){
        return `${STORAGE_TURNOS_BASE}_${myCode}`;
      }
      return STORAGE_TURNOS_BASE;
    }

    function getTurnos(){
      const key = getTurnosStorageKey();
      const t = localStorage.getItem(key);
      if(t){ return JSON.parse(t); }
      return [];
    }

    function saveTurnos(t){
      const key = getTurnosStorageKey();
      localStorage.setItem(key, JSON.stringify(t));
    }

    // ====================
    // SERVICIOS / HORARIOS
    // ====================
    function getServicios(){
      const s = localStorage.getItem(STORAGE_SERVICIOS);
      if(s){ return JSON.parse(s); }
      return [
        {nombre:"Corte caballero", precio:"5000"},
        {nombre:"Corte dama", precio:"7000"},
        {nombre:"Color", precio:"9000"},
      ];
    }
    function saveServicios(s){ localStorage.setItem(STORAGE_SERVICIOS, JSON.stringify(s)); }

    function getHorarios(){
      const h = localStorage.getItem(STORAGE_HORARIOS);
      if(h){ return JSON.parse(h); }
      const base = {};
      dias.forEach((d,i)=>{
        if(i<6){
          base[i] = {enabled:true, maniana:{inicio:"09:00",fin:"13:00"}, tarde:{inicio:"16:00",fin:"20:00"}};
        } else {
          base[i] = {enabled:false, maniana:{inicio:"",fin:""}, tarde:{inicio:"",fin:""}};
        }
      });
      return base;
    }
    function saveHorarios(h){ localStorage.setItem(STORAGE_HORARIOS, JSON.stringify(h)); }

    // ====================
    // ELEMENTOS
    // ====================
    const registerPanel = document.getElementById("registerPanel");
    const appPanel = document.getElementById("appPanel");
    const adminBadge = document.getElementById("adminBadge");
    const adminPhoneLabel = document.getElementById("adminPhoneLabel");
    const publicLinkInput = document.getElementById("publicLink");
    const copyLinkBtn = document.getElementById("copyLink");
    const listaTurnos = document.getElementById("listaTurnos");
    const agendaFecha = document.getElementById("agendaFecha");
    const disabledDayPicker = document.getElementById("disabledDayPicker");
    const addDisabledDayBtn = document.getElementById("addDisabledDay");
    const disabledDaysList = document.getElementById("disabledDaysList");
    const useWeeklyChk = document.getElementById("useWeekly");
    const msgServicios = document.getElementById("msgServicios");

    let adminPhoneVal = getAdminPhone();
    let adminCodeVal = getAdminCode();
    let isAdmin = false;

    // 2) si no hubo tel del p√∫blico, lo busco en Firestore
    async function loadPublicConfigByCode(code){
      try{
        const doc = await db.collection("admins").doc(code).get();
        if(doc.exists){
          const data = doc.data();
          if(!publicAdminPhone && data.phone){
            publicAdminPhone = data.phone;
          }
          if(data.servicios){ saveServicios(data.servicios); }
          if(data.horarios){ saveHorarios(data.horarios); }
          if(Array.isArray(data.disabledDays)){ saveDisabledDays(data.disabledDays); }
          if(typeof data.useWeekly === "boolean"){ setUseWeekly(data.useWeekly); }
        }
      }catch(e){
        console.log("No pude leer admin por code", e);
      }
    }

    // ================
    // SUSCRIPCI√ìN FIRESTORE (para admin)  (mezclando para no borrar)
    // ================
    let unsubscribeTurnos = null;
    function suscribirTurnosDeFirestore(adminCode){
      if(!adminCode) return;
      if(unsubscribeTurnos){ unsubscribeTurnos(); }
      unsubscribeTurnos = db
        .collection("admins")
        .doc(adminCode)
        .collection("turnos")
        .onSnapshot((snap)=>{
          const turnosFS = [];
          snap.forEach(doc=>{
            turnosFS.push(doc.data());
          });
          const turnosLocal = getTurnos();
          const mezcla = [...turnosLocal];
          turnosFS.forEach(fst=>{
            const idx = mezcla.findIndex(x => x.fecha === fst.fecha && x.hora === fst.hora);
            if(idx >= 0){
              mezcla[idx] = fst;
            } else {
              mezcla.push(fst);
            }
          });
          mezcla.sort((a,b)=>{
            if(a.fecha===b.fecha){ return a.hora.localeCompare(b.hora); }
            return a.fecha.localeCompare(b.fecha);
          });
          saveTurnos(mezcla);
          if(agendaFecha && agendaFecha.value){
            renderListaTurnos();
          }
          const fechaTurno = document.getElementById("fechaTurno");
          if(fechaTurno && fechaTurno.value){
            renderHorariosDisponibles(fechaTurno.value);
          }
        }, (err)=>{
          console.log("Error escuchando turnos", err);
        });
    }

    // ====================
    // INICIALIZACI√ìN
    // ====================
    if(isPublicLink){
      (async ()=>{
        if(publicCode){
          await loadPublicConfigByCode(publicCode);
        }
        registerPanel.classList.add("hidden");
        appPanel.classList.remove("hidden");
        adminBadge.style.display = "none";
        isAdmin = false;
        document.getElementById("tabTurnos").style.display = "none";
        document.getElementById("tabAjustes").style.display = "none";

        renderServiciosSelect();
        const todayIso = new Date().toISOString().split("T")[0];
        document.getElementById("fechaTurno").value = todayIso;
        renderHorariosDisponibles(todayIso);
      })();
    } else {
      // modo admin
      if(!adminPhoneVal){
        registerPanel.classList.remove("hidden");
        appPanel.classList.add("hidden");
      } else {
        registerPanel.classList.add("hidden");
        appPanel.classList.remove("hidden");
        adminBadge.style.display = "flex";
        adminPhoneLabel.textContent = "Admin registrado: " + adminPhoneVal;
        isAdmin = true;
        if(adminCodeVal){
          suscribirTurnosDeFirestore(adminCodeVal);
        }
      }
    }

    // ====================
    // GUARDAR ADMIN
    // ====================
    document.getElementById("saveAdmin").addEventListener("click", async ()=>{
      const val = document.getElementById("adminPhone").value.trim();
      if(!val){ alert("Ingres√° un n√∫mero"); return; }
      setAdminPhone(val);
      let code = getAdminCode();
      if(!code){
        code = generateAdminCode();
        setAdminCode(code);
      }
      await db.collection("admins").doc(code).set({
        phone: val,
        servicios: getServicios(),
        horarios: getHorarios(),
        disabledDays: getDisabledDays(),
        useWeekly: getUseWeekly(),
        updated: new Date().toISOString()
      }, {merge:true});
      suscribirTurnosDeFirestore(code);
      location.reload();
    });

    // ====================
    // CERRAR SESI√ìN
    // ====================
    const cerrarSesionBtn = document.getElementById("cerrarSesion");
    if(cerrarSesionBtn){
      cerrarSesionBtn.addEventListener("click", ()=>{
        if(confirm("¬øCerrar sesi√≥n de admin?")){
          localStorage.removeItem(STORAGE_ADMIN);
          localStorage.removeItem(STORAGE_ADMIN_CODE);
          location.reload();
        }
      });
    }

    // ====================
    // Tabs
    // ====================
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabTomar = document.getElementById("tab-tomar");
    const tabTurnosDiv = document.getElementById("tab-turnos");
    const tabAjustes = document.getElementById("tab-ajustes");
    const tabTurnosBtn = document.getElementById("tabTurnos");
    const tabAjustesBtn = document.getElementById("tabAjustes");

    if(!isPublicLink){
      if(!isAdmin){
        tabTurnosBtn.style.display = "none";
        tabAjustesBtn.style.display = "none";
      }
    }

    function activarTab(nombre){
      tabButtons.forEach(b=>b.classList.remove("active"));
      tabTomar.classList.add("hidden");
      tabTurnosDiv.classList.add("hidden");
      tabAjustes.classList.add("hidden");
      if(nombre==="tomar"){
        document.querySelector('[data-tab="tomar"]').classList.add("active");
        tabTomar.classList.remove("hidden");
      }
      if(nombre==="turnos"){
        document.querySelector('[data-tab="turnos"]').classList.add("active");
        tabTurnosDiv.classList.remove("hidden");
      }
      if(nombre==="ajustes"){
        document.querySelector('[data-tab="ajustes"]').classList.add("active");
        tabAjustes.classList.remove("hidden");
      }
    }

    tabButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tab = btn.dataset.tab;
        activarTab(tab);
        if(tab==="turnos") renderListaTurnos();
      });
    });

    const irTomar = document.getElementById("irTomar");
    if(irTomar){
      irTomar.addEventListener("click", e=>{
        e.preventDefault();
        activarTab("tomar");
      });
    }

    // ====================
    // Link p√∫blico (admin) ‚Üí formato corto
    // ====================
    if(!isPublicLink){
      const base = location.origin + location.pathname;
      let code = getAdminCode() || "ADM-NO-CODE";
      const phone = getAdminPhone() || "";
      const tokenObj = {c: code, p: phone};
      const token = btoa(JSON.stringify(tokenObj));
      if(publicLinkInput){
        publicLinkInput.value = `${base}?t=${encodeURIComponent(token)}`;
      }
      if(copyLinkBtn){
        copyLinkBtn.addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText(publicLinkInput.value);
            copyLinkBtn.textContent = "‚úÖ Copiado";
            setTimeout(()=>copyLinkBtn.textContent="üìã Copiar", 1600);
          }catch(e){
            alert("Copi√° el link manualmente");
          }
        });
      }
    }

    // ====================
    // Servicios
    // ====================
    const serviciosList = document.getElementById("serviciosList");
    const servicioSelect = document.getElementById("servicioSelect");
    const guardarServiciosBtn = document.getElementById("guardarServicios");

    function renderServiciosAjustes(){
      const servicios = getServicios();
      serviciosList.innerHTML = "";
      servicios.forEach((s,idx)=>{
        const wrap = document.createElement("div");
        wrap.className = "service-item";
        wrap.innerHTML = `
          <input data-idx="${idx}" data-type="nombre" value="${s.nombre}" placeholder="Servicio">
          <input data-idx="${idx}" data-type="precio" value="${s.precio}" style="max-width:120px;" placeholder="$">
          <button data-idx="${idx}" class="btn btn-soft" type="button">üóë</button>
        `;
        serviciosList.appendChild(wrap);
        wrap.querySelector("button").addEventListener("click", ()=>{
          const arr = getServicios();
          arr.splice(idx,1);
          saveServicios(arr);
          renderServiciosAjustes();
          renderServiciosSelect();
          syncAdminConfigToFirestore();
        });
        wrap.querySelectorAll("input").forEach(inp=>{
          inp.addEventListener("input", ()=>{
            const arr = getServicios();
            const i = parseInt(inp.dataset.idx);
            const type = inp.dataset.type;
            arr[i][type] = inp.value;
            saveServicios(arr);
            renderServiciosSelect();
          });
        });
      });
    }

    // ‚úÖ nuevo bot√≥n "Guardar precios"
    if(guardarServiciosBtn){
      guardarServiciosBtn.addEventListener("click", async ()=>{
        await syncAdminConfigToFirestore();
        if(msgServicios){
          msgServicios.textContent = "Servicios guardados ‚úîÔ∏è";
          setTimeout(()=>{ msgServicios.textContent=""; }, 2000);
        }
      });
    }

    function renderServiciosSelect(){
      const servicios = getServicios();
      servicioSelect.innerHTML = "";
      servicios.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.nombre;
        opt.textContent = s.nombre + " ($" + s.precio + ")";
        servicioSelect.appendChild(opt);
      });
    }

    document.getElementById("agregarServicio").addEventListener("click", ()=>{
      const arr = getServicios();
      arr.push({nombre:"Nuevo servicio", precio:"0"});
      saveServicios(arr);
      renderServiciosAjustes();
      renderServiciosSelect();
    });

    // ====================
    // Horarios
    // ====================
    const horariosPorDia = document.getElementById("horariosPorDia");
    const fechaTurno = document.getElementById("fechaTurno");

    function renderHorariosAjustes(){
      const h = getHorarios();
      horariosPorDia.innerHTML = "";
      dias.forEach((dia,idx)=>{
        const config = h[idx];
        const box = document.createElement("div");
        box.className = "day-box";
        box.innerHTML = `
          <h4>${dia} <input type="checkbox" class="switch" ${config.enabled?"checked":""} data-dia="${idx}"></h4>
          <small>Ma√±ana</small>
          <div class="row" style="margin-bottom:.3rem;">
            <div class="col-6"><input type="time" data-dia="${idx}" data-part="man_inicio" value="${config.maniana.inicio||""}"></div>
            <div class="col-6"><input type="time" data-dia="${idx}" data-part="man_fin" value="${config.maniana.fin||""}"></div>
          </div>
          <small>Tarde</small>
          <div class="row">
            <div class="col-6"><input type="time" data-dia="${idx}" data-part="tar_inicio" value="${config.tarde.inicio||""}"></div>
            <div class="col-6"><input type="time" data-dia="${idx}" data-part="tar_fin" value="${config.tarde.fin||""}"></div>
          </div>
        `;
        horariosPorDia.appendChild(box);
      });

      horariosPorDia.querySelectorAll("input[type=checkbox]").forEach(ch=>{
        ch.addEventListener("change", ()=>{
          const idx = ch.dataset.dia;
          const data = getHorarios();
          data[idx].enabled = ch.checked;
          saveHorarios(data);
          renderHorariosDisponibles(fechaTurno.value);
          syncAdminConfigToFirestore();
        });
      });
      horariosPorDia.querySelectorAll("input[type=time]").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const idx = inp.dataset.dia;
          const part = inp.dataset.part;
          const data = getHorarios();
          if(part==="man_inicio") data[idx].maniana.inicio = inp.value;
          if(part==="man_fin") data[idx].maniana.fin = inp.value;
          if(part==="tar_inicio") data[idx].tarde.inicio = inp.value;
          if(part==="tar_fin") data[idx].tarde.fin = inp.value;
          saveHorarios(data);
          renderHorariosDisponibles(fechaTurno.value);
          syncAdminConfigToFirestore();
        });
      });
    }

    // ‚úÖ dias deshabilitados UI
    function renderDisabledDays(){
      const arr = getDisabledDays();
      disabledDaysList.innerHTML = "";
      if(arr.length===0){
        disabledDaysList.innerHTML = `<small style="font-size:.7rem;color:#777;">No hay d√≠as deshabilitados.</small>`;
        return;
      }
      arr.forEach(d=>{
        const tag = document.createElement("span");
        tag.className = "tag-disabled";
        tag.innerHTML = `${d} <button type="button" style="border:none;background:none;cursor:pointer;">‚úï</button>`;
        tag.querySelector("button").addEventListener("click", ()=>{
          const now = getDisabledDays().filter(x=>x!==d);
          saveDisabledDays(now);
          renderDisabledDays();
          syncAdminConfigToFirestore();
        });
        disabledDaysList.appendChild(tag);
      });
    }

    if(addDisabledDayBtn){
      addDisabledDayBtn.addEventListener("click", ()=>{
        const val = disabledDayPicker.value;
        if(!val) return;
        const arr = getDisabledDays();
        if(!arr.includes(val)){
          arr.push(val);
        }
        saveDisabledDays(arr);
        renderDisabledDays();
        syncAdminConfigToFirestore();
      });
    }

    // ‚úÖ switch usar semanal
    if(useWeeklyChk){
      useWeeklyChk.checked = getUseWeekly();
      useWeeklyChk.addEventListener("change", ()=>{
        setUseWeekly(useWeeklyChk.checked);
        renderHorariosDisponibles(document.getElementById("fechaTurno").value);
        syncAdminConfigToFirestore();
      });
    }

    async function syncAdminConfigToFirestore(){
      if(isPublicLink) return;
      const phone = getAdminPhone();
      const code = getAdminCode();
      if(!phone || !code) return;
      await db.collection("admins").doc(code).set({
        phone,
        servicios: getServicios(),
        horarios: getHorarios(),
        disabledDays: getDisabledDays(),
        useWeekly: getUseWeekly(),
        updated: new Date().toISOString()
      }, {merge:true});
    }

    document.getElementById("guardarAjustes").addEventListener("click", async ()=>{
      await syncAdminConfigToFirestore();
      document.getElementById("msgAjustes").textContent = "Ajustes guardados ‚úîÔ∏è";
      setTimeout(()=>{ document.getElementById("msgAjustes").textContent=""; }, 2000);
    });

    // ====================
    // Horarios disponibles
    // ====================
    const horariosContainer = document.getElementById("horariosContainer");
    let horarioSeleccionado = null;

    function setTodayAsDefault(){
      const today = new Date();
      const iso = today.toISOString().split("T")[0];
      if(fechaTurno) fechaTurno.value = iso;
      if(agendaFecha) agendaFecha.value = iso;
      renderHorariosDisponibles(iso);
      renderListaTurnos();
    }

    function timeToMinutes(t){ const [h,m] = t.split(":").map(Number); return h*60+m; }
    function minutesToTime(m){ const h = Math.floor(m/60); const min = m%60; return String(h).padStart(2,"0")+":"+String(min).padStart(2,"0"); }

    function renderHorariosDisponibles(fechaStr){
      if(!horariosContainer) return;
      horariosContainer.innerHTML = "";
      horarioSeleccionado = null;

      // si el d√≠a est√° deshabilitado -> mensaje
      const disabledDays = getDisabledDays();
      if(disabledDays.includes(fechaStr)){
        horariosContainer.innerHTML = `<div class="empty">Este d√≠a est√° deshabilitado</div>`;
        return;
      }

      const useWeekly = getUseWeekly();
      if(!useWeekly){
        horariosContainer.innerHTML = `<div class="empty">La agenda semanal est√° desactivada</div>`;
        return;
      }

      const date = new Date(fechaStr+"T00:00:00");
      const dayIdx = (date.getDay()+6)%7;
      const horarios = getHorarios();
      const conf = horarios[dayIdx];
      if(!conf || !conf.enabled){
        horariosContainer.innerHTML = `<div class="empty">Este d√≠a no hay horarios habilitados</div>`;
        return;
      }
      let bloques = [];
      if(conf.maniana.inicio && conf.maniana.fin){
        let start = timeToMinutes(conf.maniana.inicio);
        const end = timeToMinutes(conf.maniana.fin);
        while(start+30 <= end){
          bloques.push(minutesToTime(start));
          start += 30;
        }
      }
      if(conf.tarde.inicio && conf.tarde.fin){
        let start = timeToMinutes(conf.tarde.inicio);
        const end = timeToMinutes(conf.tarde.fin);
        while(start+30 <= end){
          bloques.push(minutesToTime(start));
          start += 30;
        }
      }
      const turnos = getTurnos().filter(t=>t.fecha===fechaStr);
      const usados = turnos.map(t=>t.hora);

      if(bloques.length===0){
        horariosContainer.innerHTML = `<div class="empty">No hay bloques configurados</div>`;
        return;
      }

      bloques.forEach(b=>{
        const btn = document.createElement("button");
        btn.type="button";
        btn.textContent = b;
        btn.style.minWidth="80px";
        btn.style.border="1px solid #ddd";
        btn.style.borderRadius="10px";
        btn.style.padding=".35rem .6rem";
        btn.style.background="#fff";
        btn.style.cursor="pointer";
        btn.style.fontWeight="600";
        btn.style.color="#333";
        if(usados.includes(b)){
          btn.style.background="rgba(214,40,40,.1)";
          btn.style.color="var(--rojo)";
          btn.textContent = b + " ‚Äî OCUPADO";
          btn.disabled = true;
        } else {
          btn.addEventListener("click", ()=>{
            horariosContainer.querySelectorAll("button").forEach(x=>x.style.background="#fff");
            btn.style.background="rgba(8,160,209,.1)";
            horarioSeleccionado = b;
          });
        }
        horariosContainer.appendChild(btn);
      });
    }

    if(fechaTurno){
      fechaTurno.addEventListener("change", e=>{
        renderHorariosDisponibles(e.target.value);
      });
    }

    // ====================
    // Notificar admin (panel)
    // ====================
    function notificarAdmin(turno){
      const admin = getAdminPhone();
      if(!admin) return;
      const texto = `Nuevo turno en la peluquer√≠a:%0ACliente: ${encodeURIComponent(turno.nombre)}%0AFecha: ${turno.fecha}%0AHora: ${turno.hora}%0AServicio: ${encodeURIComponent(turno.servicio)}%0ATel cliente: ${turno.tel || "sin tel√©fono"}`;
      const limpio = admin.replace(/[^0-9+]/g,"");
      const url = `https://wa.me/${limpio}?text=${texto}`;
      const linkWhats = document.getElementById("linkWhats");
      if(linkWhats){
        linkWhats.innerHTML = `üì≤ <a href="${url}" target="_blank" style="color:var(--celeste);text-decoration:none;">Enviar aviso por WhatsApp al admin</a>`;
      }
    }

    // ====================
    // Confirmar turno
    // ====================
    document.getElementById("confirmarTurno").addEventListener("click", async ()=>{
      const nombre = document.getElementById("clienteNombre").value.trim();
      const tel = document.getElementById("clienteTel").value.trim();
      const fecha = document.getElementById("fechaTurno").value;
      const servicio = document.getElementById("servicioSelect").value;
      const msg = document.getElementById("msgTurno");

      if(!nombre){ msg.textContent="Pon√© el nombre del cliente."; msg.style.color="red"; return; }
      if(!fecha){ msg.textContent="Eleg√≠ la fecha."; msg.style.color="red"; return; }

      // no dejar si est√° deshabilitado
      if(getDisabledDays().includes(fecha)){
        msg.textContent="Ese d√≠a est√° deshabilitado.";
        msg.style.color="red";
        return;
      }

      if(!getUseWeekly()){
        msg.textContent="La agenda est√° desactivada.";
        msg.style.color="red";
        return;
      }

      if(!horarioSeleccionado){ msg.textContent="Eleg√≠ un horario disponible."; msg.style.color="red"; return; }

      const turnos = getTurnos();
      if(turnos.some(t=>t.fecha===fecha && t.hora===horarioSeleccionado)){
        msg.textContent="Ese horario ya fue tomado. Eleg√≠ otro.";
        msg.style.color="red";
        return;
      }

      const adminLocal = getAdminPhone();   // panel
      const code = isPublicLink ? publicCode : getAdminCode();

      const nuevo = {
        fecha,
        hora: horarioSeleccionado,
        nombre,
        tel,
        servicio,
        creado: new Date().toISOString(),
        notificarA: isPublicLink ? (publicAdminPhone || "") : (adminLocal || ""),
        adminCode: code || ""
      };

      // guardo local
      turnos.push(nuevo);
      turnos.sort((a,b)=>{
        if(a.fecha===b.fecha){ return a.hora.localeCompare(b.hora); }
        return a.fecha.localeCompare(b.fecha);
      });
      saveTurnos(turnos);

      msg.style.color="green";
      msg.textContent = "Turno guardado ‚úîÔ∏è";

      document.getElementById("clienteNombre").value = "";
      document.getElementById("clienteTel").value = "";

      renderHorariosDisponibles(fecha);
      renderListaTurnos();
      notificarAdmin(nuevo);

      // root
      db.collection("turnos").add(nuevo).catch(e=>console.log("Error subiendo turno (root)", e));

      // subcolecci√≥n del admin
      if(code){
        const docId = `${fecha}_${horarioSeleccionado}`.replace(/:/g,"-");
        db.collection("admins")
          .doc(code)
          .collection("turnos")
          .doc(docId)
          .set(nuevo)
          .catch(e=>console.log("Error subiendo turno al admin", e));
      }

      // si es p√∫blico ‚Üí abrir WhatsApp del admin due√±o
      if(isPublicLink && publicAdminPhone){
        const limpio = publicAdminPhone.replace(/[^0-9+]/g,"");
        const texto = encodeURIComponent(
          `Nuevo turno en la peluquer√≠a:\nCliente: ${nuevo.nombre}\nFecha: ${nuevo.fecha}\nHora: ${nuevo.hora}\nServicio: ${nuevo.servicio}\nTel cliente: ${nuevo.tel || "sin tel√©fono"}`
        );
        window.location.href = `https://wa.me/${limpio}?text=${texto}`;
      }
    });

    // ====================
    // Lista Turnos (ADMIN)
    // ====================
    if(agendaFecha){
      agendaFecha.addEventListener("change", ()=>renderListaTurnos());
    }

    function eliminarTurno(turnoObj){
      let turnos = getTurnos();
      turnos = turnos.filter(t=>!(t.fecha === turnoObj.fecha && t.hora === turnoObj.hora));
      saveTurnos(turnos);
      renderListaTurnos();
      if(fechaTurno && fechaTurno.value === turnoObj.fecha){
        renderHorariosDisponibles(turnoObj.fecha);
      }
      // borrar en firestore root
      db.collection("turnos")
        .where("fecha","==", turnoObj.fecha)
        .where("hora","==", turnoObj.hora)
        .where("adminCode","==", turnoObj.adminCode || "")
        .get().then(snap=>{
          snap.forEach(doc=>doc.ref.delete().catch(()=>{}));
        });

      // borrar en subcolecci√≥n del admin
      const adminCode = getAdminCode();
      if(adminCode){
        const docId = `${turnoObj.fecha}_${turnoObj.hora}`.replace(/:/g,"-");
        db.collection("admins")
          .doc(adminCode)
          .collection("turnos")
          .doc(docId)
          .delete()
          .catch(()=>{});
      }
    }

    function renderListaTurnos(){
      if(isPublicLink) return;
      if(!isAdmin) return;
      const fecha = agendaFecha.value;
      const turnos = getTurnos().filter(t=>t.fecha===fecha);
      listaTurnos.innerHTML = "";
      if(turnos.length===0){
        listaTurnos.innerHTML = `<div class="empty">No hay turnos para esta fecha.</div>`;
        return;
      }
      turnos.forEach(t=>{
        const card = document.createElement("div");
        card.className = "turno-card";
        card.innerHTML = `
          <div class="turno-info">
            <span class="hora-badge">üïí ${t.hora}</span>
            <strong>${t.nombre}</strong>
            <small>${t.servicio}${t.tel?(" ‚Ä¢ " + t.tel):""}</small>
          </div>
          <button class="btn btn-danger" type="button">üóë Eliminar</button>
        `;
        const btn = card.querySelector("button");
        btn.addEventListener("click", ()=>{
          if(confirm("¬øEliminar este turno?")){
            eliminarTurno(t);
          }
        });
        listaTurnos.appendChild(card);
      });
    }

    // ====================
    // INIT UI
    // ====================
    renderServiciosAjustes();
    renderServiciosSelect();
    renderHorariosAjustes();
    renderDisabledDays();
    useWeeklyChk.checked = getUseWeekly();
    setTodayAsDefault();
    if(isPublicLink){ activarTab("tomar"); }
  </script>
</body>
</html>
